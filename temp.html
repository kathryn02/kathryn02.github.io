<!DOCTYPE html>
<html>
  <head>
    <title>Budget Beer</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type="text/javascript" src="http://oauth.googlecode.com/svn/code/javascript/oauth.js"></script>
    <script type="text/javascript" src="http://oauth.googlecode.com/svn/code/javascript/sha1.js"></script>
    <link rel="stylesheet" href="home.css">

    <style>
    .button {
        background-color: #A8A8A7;
        border: none;
        color: black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        font-weight: bold;
        display: inline-block;
         font-family: 'Helvetica', sans-serif;
        font-size: 26px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 12px;
        margin-top: -80px;
        margin-left: 1025px;
        position: fixed;
    }
    </style>
  </head>

  <body>
    <div class="container">
    <div class="blurb">
      <h1>Budget Beer</h1>

    </div><!-- /.blurb -->
    </div><!-- /.container -->
    <footer>
            <h2>Enter City or Zip:</h2>
            <div class="flexsearch">
                    <div class="flexsearch--wrapper">
                            <form class="flexsearch--form" action="#" method="post">
                                    <div class="flexsearch--input-wrapper">
                                            <input id="textbox" class="flexsearch--input" type="search" placeholder="input">
                                    </div>
                            </form>
                            <button id="buttonSearch" class="button" onclick="search()">Search</button>
                    </div>
            </div>
    </footer>
    <footer></footer>



    <script type="text/javascript">

      function search() {
        var auth = {
            consumerKey: 'jpRGb46Cuy-dZ47dbzfoWQ',
            consumerSecret: 'jnDPUIHGqLvDIjxgwyqKwlgzmnU',
            accessToken: 'XNWzHcvPUa3-xyikajnKrrt3KRjum42G',
            accessTokenSecret: 'R9ai_0TmPbnpp16fEaeNfFs7hQQ',
            serviceProvider : {
                signatureMethod : "HMAC-SHA1"
            }
        };

        var terms = 'bar';
        var near = document.getElementById('textbox').value;

        var accessor = {
            consumerSecret : auth.consumerSecret,
            tokenSecret : auth.accessTokenSecret
        };

        parameters = [];
        parameters.push(['term', terms]);
        parameters.push(['location', near]);
        parameters.push(['callback', 'cb']);
        parameters.push(['oauth_consumer_key', auth.consumerKey]);
        parameters.push(['oauth_consumer_secret', auth.consumerSecret]);
        parameters.push(['oauth_token', auth.accessToken]);
        parameters.push(['oauth_signature_method', auth.serviceProvider.signatureMethod]);

        var message = {
            'action' : 'http://api.yelp.com/v2/search',
            'method' : 'GET',
            'parameters' : parameters
        };

        OAuth.setTimestampAndNonce(message);
        OAuth.SignatureMethod.sign(message, accessor);

        var parameterMap = OAuth.getParameterMap(message.parameters);

        $.ajax({
            'url' : message.action,
            'data' : parameterMap,
            'dataType' : 'jsonp',
            'jsonpCallback' : 'cb',
            'success' : function(data, textStats, XMLHttpRequest) {
                var temp = data.businesses;
                var info = get_data(temp);
                var rank = get_rank(info, 30.6280, -96.334);

                for(i = 0; i < info.length; ++i) {
                //  $("body").append("<br>" + info[i].price);
                  $("body").append("<br><a href=\"" + info[i].url + "\">" + info[i].name + "</a> -----> " 
                    + info[i].rating + " -----> " + info[i].address[0] + " " + info[i].address[1]);
                }
                $("body").append("<br>");
                for(i = 0; i < 5; ++i) {
                  $("body").append("<br>" + i + ". <a href=\"" + rank[i].url + "\">" + rank[i].name + "</a> -----> "
                    + rank[i].price);
                }
            }
        });
      }
    

      function get_data(bars) {
        var data = [];
        for(i = 0; i < bars.length; ++i) {
          var temp = {name:"", rating:0, latitude:0, longitude:0, address:[], url:"",price:0.0,score:0.0}
          temp.name = bars[i].name;
          temp.rating = bars[i].rating;
          temp.latitude = bars[i].location.coordinate.latitude;
          temp.longitude = bars[i].location.coordinate.longitude;
          temp.address = bars[i].location.display_address;
          temp.url = bars[i].url;
          temp.price = (Math.random() * 2);
          data.push(temp);
        }
        return data;
      }    

      function get_rank(bars, currLat, currLon) {
        var scores = [];
        var sorted = [];
        var totalStars = 0.0;
        var avgStars = 0.0;
        var sumPrice = 0.0;
        var avgPrice = 0.0;

        var data = [];
        // get difference in location
        var temp = 0.0;
        for(i = 0; i < bars.length; ++i) {
          temp = Math.abs(currLat - bars[i].latitude);
          temp += Math.abs(currLon - bars[i].longitude);
          scores.push(Math.cos(1.0 - temp));
          sorted.push(Math.cos(1.0 - temp));
          temp = 0.0;

          totalStars += bars[i].rating;
          sumPrice += bars[i].price;
        }
        avgStars = totalStars/bars.length;
        avgPrice = sumPrice/bars.length;

        // take avg star rating and get relative value
        for(j = 0; j < bars.length; ++j) {
          scores[j] += Math.cos((bars[j].rating - avgStars)/avgStars);
          sorted[j] += Math.cos((bars[j].rating - avgStars)/avgStars);
        }

        // account for price
        for(k = 0; k < bars.length; ++k) {
          scores[k] += bars[k].price/avgPrice;
          sorted[k] += bars[k].price/avgPrice;
        }
        sorted.sort();

        // sort out final list
        for(k = 1; k < 6; ++k) {
          for(l = 0; l < bars.length; ++l) {
            if(sorted[k] == scores[l])
              bars[l].price = sorted[k];
              data.push(bars[l]);
          }
        }

        return data;
      }
    </script>
  </body>
</html>
